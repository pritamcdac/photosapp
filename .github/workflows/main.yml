name: Mobile CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # android:
  #   name: Android Release
  #   runs-on: ubuntu-latest

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Setup JDK 17
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: 17

  #     - name: Setup Node
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'

  #     - name: Install JS deps
  #       run: npm install

  #     # üîë Decode keystore
  #     - name: Decode Keystore
  #       run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

  #     # üîë Configure Gradle signing
  #     - name: Configure Gradle signing
  #       working-directory: android
  #       run: |
  #         echo "MYAPP_UPLOAD_STORE_FILE=upload-keystore.jks" >> gradle.properties
  #         echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> gradle.properties
  #         echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> gradle.properties
  #         echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}" >> gradle.properties
  #         cat gradle.properties

  #     - name: Make gradlew executable
  #       working-directory: android
  #       run: chmod +x gradlew
     
  #     - name: Build AAB
  #       run: cd android && ./gradlew bundleRelease --stacktrace

  #     - name: Upload to Play Console
  #       uses: r0adkll/upload-google-play@v1
  #       with:
  #         serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
  #         packageName: com.cybage.photosapp
  #         releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
  #         track: internal
  #         status: draft


  ios:
    name: iOS Build & Upload
    runs-on: macos-14
    # needs: android

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
           xcode-version: '16.1'
     
      - name: üì¶ Install JS dependencies
        run: npm install
     
      - name: üì¶ Set up CocoaPods and build
        run: |
         cd ios
         rm -rf Pods Podfile.lock
         pod install

      - name: Install Dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Decode Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/CybageCI.mobileprovision
      
      - name: üîç List schemes
        run: xcodebuild -list -workspace ios/PhotosApp.xcworkspace
 
      - name: üìÉ Install provisioning profile
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/CybageCI.mobileprovision"


      - name: üîç List code‚Äësigning identities (debug)
        run: security find-identity -v -p codesigning


      - name: üì¶ Archive iOS app
        run: |
         # xcodebuild \
         # -workspace ios/PhotosApp.xcworkspace \
         # -scheme PhotosApp \
         # -configuration Release \
         # -archivePath $PWD/build/PhotosApp.xcarchive \
         # -destination "generic/platform=iOS" \
         # CODE_SIGN_STYLE=Manual \
         # DEVELOPMENT_TEAM=VB78Y67GX6 \
         # PROVISIONING_PROFILE_SPECIFIER=CybageCI \
         # CODE_SIGN_IDENTITY="Apple Distribution: CYBAGE SOFTWARE, INC. (VB78Y67GX6)" \
         # OTHER_CODE_SIGN_FLAGS="--keychain /Users/runner/Library/Keychains/login.keychain-db" \
         # archive

         xcodebuild -workspace ios/PhotosApp.xcworkspace \
         -scheme PhotosApp \
         -configuration Release \
         -sdk iphoneos \
         -archivePath $PWD/build/PhotosApp.xcarchive archive \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=VB78Y67GX6 \
         PROVISIONING_PROFILE_SPECIFIER="CybageCI" \
         CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/PhotosApp.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath $PWD/build

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/PhotosApp.ipa
          issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
